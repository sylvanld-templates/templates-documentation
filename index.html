<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="/assets/css/syntax_highlighting.css">
    <!-- Compiled and minified CSS -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <!-- custom javascript -->
    <script src="/assets/js/clipboard.js"></script>
    <!--<script src="/assets/js/controllers.js"></script>-->

    <style>
        ul>li {
            padding-left: 8px;
        }

        .highlight {
            border-radius: 5px;
            padding: 4px 16px;
        }
    </style>
</head>

<body>
    <header style="position: fixed; left:0; right: 0">
        <nav style="position: relative; padding: 0 8px"
            class="blue darken-1">
            <div class="nav-wrapper">
                <a href="/" class="brand-logo left" style="display: flex; align-items: center; width: 300px;">
                    <img src="/assets/img/project.svg" alt="git-template-icon"
                        style="max-height: 30px; margin-right: 0.5em">
                    Git Templates
                </a>
                <ul id="nav-mobile" class="right hide-on-med-and-down">
                    
                    <li><a href="/">Browse templates</a></li>
                    
                    <li><a href="/about">About</a></li>
                    
                </ul>
            </div>
        </nav>
    </header>

    <main style="padding-top: 50px; padding-bottom: 2em">
        <style>
    #search-form {
        margin: 15px auto 0 auto;
    }

    #showcase {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
    }

    @media screen and (max-width: 740px) {
        #showcase .card {
            width: 100%
        }
    }

    @media screen and (min-width: 740px) {
        #search-form {
            max-width: 70%
        }

        #showcase .card {
            width: 50%
        }
    }

    @media screen and (min-width: 1540px) {
        #search-form {
            max-width: 50%
        }

        #showcase .card {
            width: 30%
        }
    }

    .card-icon {
        max-height: 4em;
        max-width: 4em;
        padding: 0.5em;
    }
</style>

<div class="container">
    <form id="search-form" style="display: flex">
        <div class="input-field" style="flex: 1; margin-right: 1em">
            <input id="search-query" type="text" class="validate" placeholder="Browse templates">
            <label for="name">Name</label>
        </div>
        <div class="input-field col s2">
            <button class="btn waves-effect waves-light blue darken-1"
                type="submit" name="action">Search</button>
        </div>
    </form>

    <main id="showcase"></main>
</div>


<script>
    const cardsJson = `
    {
    "title": "Python FastAPI",
    "description": "Python self-documented REST API using FastAPI.",
    "icons": ["/assets/logo/python.svg","/assets/logo/fastapi.png","/assets/logo/swagger.svg"],
    "link": "/templates/python-fastapi.html",
    "repository": "https://github.com/sylvanld-templates/python-api"
    },
    
    {
    "title": "Python CLI package",
    "description": "Python package that exposes command line scripts.",
    "icons": ["/assets/logo/python.svg","/assets/logo/package.svg","/assets/logo/cli.svg"],
    "link": "/templates/python-package.html",
    "repository": "https://github.com/sylvanld-templates/python-package"
    },
    `.trim().slice(0, -1);

    const cards = JSON.parse(`[${cardsJson}]`);
    console.log(cards);

    function similitudeScore(search, base) {
        if (!base) return 0;

        const normalizedSearch = search.toLowerCase().replace(/([^\w]|_)/g, " ").replace(/\s+/g, " ").trim().split(" ");
        const normalizedBase = base.toLowerCase().replace(/([^\w]|_)/g, " ").replace(/\s+/g, " ").trim();
        let score = 0;
        for (let word of normalizedSearch) {
            if (normalizedBase.includes(word)) {
                score += 1;
            }
        }
        return score;
    }

    function queryScore(query, card) {
        let score = 0;
        score += 2 * similitudeScore(query, card.title);
        score += 1 * similitudeScore(query, card.description);
        return score;
    }

    function displayCards(cards) {
        const showcase = document.getElementById("showcase");
        showcase.innerHTML = "";
        for (let card of cards) {
            let icons = "";
            for (let icon of (card.icons || [])) {
                icons += `<img src="${icon}" alt="${icon}" class="card-icon">`;
            }

            const copyRepoLink = card.repository ? `<a href="#" class="btn waves-effect waves-light pink darken-3 right" data-copy="${card.repository}">Copy reference</a>` : '';
            showcase.innerHTML += `
            <div class="card small">
                <div class="card-content">
                    <h2 class="card-title">${card.title}</h2>
                    <div style="display: flex">${icons}</div>
                    <p>${card.description}</p>
                </div>

                <footer class="card-action">
                    <a class="btn waves-effect waves-light blue darken-1" href="${card.link}">Documentation</a>
                    ${copyRepoLink}
                </footer>
            </div>
            `;
        }
        reloadListeners("#showcase");
    }

    function submitSearch(evt) {
        const searchInput = document.querySelector('#search-query');
        const query = searchInput.value;

        // workout search score for all cards
        const results = cards
            .map(card => ({ card, score: queryScore(query, card) }))
            .filter(result => result.score > 0)
            .sort((result1, result2) => (result1.score < result2.score) ? -1 : 1)
            .map(result => result.card);

        displayCards(results);

        // clear input after query has been done
        searchInput.value = "";
        evt.preventDefault();
    }

    document.addEventListener("DOMContentLoaded", () => {
        displayCards(cards);
        document.getElementById('search-form').addEventListener('submit', submitSearch);
    })
</script>
    </main>
</body>

<script>
    function copyDataToClipboard() {
        const dataToCopy = this.getAttribute("data-copy");
        copyTextToClipboard(dataToCopy);
    }

    /*
    *   Helpers functions
    */
    function bind(parent, selector, listener) {
        const nodeList = [];
        try {
            nodeList.push(...parent.querySelectorAll(selector));
        } catch {
            [...parent].map(elt => nodeList.push(...elt.querySelectorAll(selector)));
        }
        [...nodeList].map(elt => elt.addEventListener('click', listener));
    }

    function unbind(parent, selector, listener) {
        const nodeList = [];
        try {
            console.log(parent)
            nodeList.push(...parent.querySelectorAll(selector));
        } catch {
            console.log('fallback to list');
            [...parent].map(elt => nodeList.push(...elt.querySelectorAll(selector)));
        }
        console.log(nodeList);
        [...nodeList].map(elt => elt.removeEventListener('click', listener));
    }

    /*
    *   Function to cleanly (re)bound controllers listeners
    */
    function reloadListeners(selector) {
        // workout root
        const parent = selector ? document.querySelectorAll(selector) : document;
        console.log('reload controllers in element', parent);

        // bind copyToCliboard to copiables elements
        unbind(parent, '[data-copy]', copyDataToClipboard);
        bind(parent, '[data-copy]', copyDataToClipboard);
    }

    /*
    *   When DOM is loaded, bind all listeners
    */
    document.addEventListener('DOMContentLoaded', () => {
        reloadListeners();
    })
</script>

</html>